@{
    ViewData["Title"] = "AutonomateQA";
}

<div class="container mt-4">
    <h2 class="mb-4">AutonomateQA</h2>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Run New Test</h5>
                        <button class="btn btn-sm btn-light text-primary" onclick="startRecording()">Record New Test</button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="testForm">
                        <div class="mb-3">
                            <label for="SavedTests" class="form-label text-primary fw-bold">Load Saved Test</label>
                            <select class="form-select border-primary" id="SavedTests" onchange="loadSavedTest()">
                                <option value="">-- Select a saved test... --</option>
                            </select>
                        </div>
                        <hr/>

                        <div class="mb-3">
                            <label for="Url" class="form-label">Target URL</label>
                            <input type="url" class="form-control" id="Url" required placeholder="https://example.com/login" value="@(ViewData["BaseUrl"] ?? "https://example.com/login")">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label d-flex justify-content-between">
                                <span>Gherkin Script (Optional)</span>
                                <label for="fileUpload" class="text-primary" style="cursor: pointer; text-decoration: underline;">Upload .feature File</label>
                            </label>
                            <input type="file" id="fileUpload" accept=".feature" class="d-none" onchange="handleFileUpload(event)">
                            <textarea class="form-control" id="GherkinScript" rows="5" placeholder="When I type 'user' into Username..."></textarea>
                            <div class="form-text">If provided, this script overrides the default login test.</div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch border rounded p-2 ps-5 bg-light">
                                <input class="form-check-input" type="checkbox" id="Headed">
                                <label class="form-check-label ms-2" for="Headed">Show Browser (Headed Mode)</label>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success flex-grow-1" id="btnRun">Run UI Test</button>
                            <button type="button" class="btn btn-outline-primary" onclick="showSaveModal()">Save Script</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="mb-0">Execution History</h5>
                        <div class="d-flex align-items-center gap-2">
                            <label class="mb-0 small">Rows:</label>
                            <select class="form-select form-select-sm" id="pageSizeSelect" style="width: auto;" onchange="changePageSize()">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                            <button class="btn btn-sm btn-outline-secondary" onclick="fetchResults()">Refresh</button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Time</th>
                                <th>URL</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <!-- Results will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="small text-muted" id="paginationInfo">Showing 0 results</div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="paginationControls">
                            <!-- Prev/Next filled by JS -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Test Result Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <dl class="row">
          <dt class="col-sm-3">ID</dt>
          <dd class="col-sm-9" id="modalId"></dd>

          <dt class="col-sm-3">URL</dt>
          <dd class="col-sm-9 text-break" id="modalUrl"></dd>

          <dt class="col-sm-3">Status</dt>
          <dd class="col-sm-9" id="modalStatus"></dd>

          <dt class="col-sm-3">Duration</dt>
          <dd class="col-sm-9" id="modalDuration"></dd>
          
          <dt class="col-sm-3">Screenshot</dt>
          <dd class="col-sm-9" id="modalScreenshot"></dd>

          <dt class="col-sm-3 mt-2">Video</dt>
          <dd class="col-sm-9 mt-2">
             <div id="modalVideoContainer">None</div>
          </dd>
        </dl>
        
        <hr>
        
        <h6>Error Log / Message</h6>
            <textarea class="form-control" id="modalError" rows="5" readonly style="font-family: monospace; font-size: 0.9em;"></textarea>
            <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" onclick="copyError()">Copy</button>
        </div>

        <h6 class="mt-3">Execution Log (Steps & AI Reasoning)</h6>
        <div class="position-relative">
            <textarea class="form-control" id="modalReasoning" rows="10" readonly style="font-family: monospace; font-size: 0.9em; background-color: #f8f9fa;"></textarea>
            <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" onclick="copyReasoning()">Copy</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Save Test Case Modal -->
<div class="modal fade" id="saveTestModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Save Test Case</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
            <label for="saveTestName" class="form-label">Test Case Name</label>
            <input type="text" class="form-control" id="saveTestName" placeholder="e.g. Successful Login Flow">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveTest()">Save</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        let savedTestCases = [];

        // Load test cases on page load
        document.addEventListener("DOMContentLoaded", () => {
            fetchSavedTests();
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const contents = e.target.result;
                document.getElementById('GherkinScript').value = contents;
                
                // Reset the input so the same file can be uploaded again if needed
                event.target.value = '';
            };
            
            reader.onerror = function() {
                alert("Error reading file");
            };
            
            reader.readAsText(file);
        }

        async function fetchSavedTests() {
            try {
                const response = await fetch('/TestRunner/GetTestCases');
                if (response.ok) {
                    savedTestCases = await response.json();
                    const select = document.getElementById('SavedTests');
                    // Keep the first placeholder option, clear the rest
                    select.innerHTML = '<option value="">-- Select a saved test... --</option>';
                    
                    savedTestCases.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.id;
                        opt.textContent = t.name;
                        select.appendChild(opt);
                    });
                }
            } catch (err) {
                console.error("Failed to fetch saved tests", err);
            }
        }

        function loadSavedTest() {
            const select = document.getElementById('SavedTests');
            const selectedId = select.value;
            
            if (!selectedId) return; // Ignore if placeholder selected

            const testCase = savedTestCases.find(t => t.id == selectedId);
            if (testCase) {
                document.getElementById('Url').value = testCase.url;
                document.getElementById('GherkinScript').value = testCase.gherkinScript || '';
            }
        }

        function showSaveModal() {
            const url = document.getElementById('Url').value;
            if (!url) {
                alert("Please enter at least a Target URL before saving.");
                return;
            }
            const modal = new bootstrap.Modal(document.getElementById('saveTestModal'));
            modal.show();
        }

        async function saveTest() {
            const name = document.getElementById('saveTestName').value;
            if (!name) {
                alert("Please provide a name for the test case.");
                return;
            }

            const data = {
                Name: name,
                Url: document.getElementById('Url').value,
                GherkinScript: document.getElementById('GherkinScript').value
            };

            try {
                const response = await fetch('/TestRunner/SaveTestCase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    // Close Modal
                    const modalEl = document.getElementById('saveTestModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();

                    document.getElementById('saveTestName').value = ''; // Reset
                    
                    // Refresh List
                    await fetchSavedTests();
                    
                    // Select the newly added item (assuming latest is added at the top or bottom, we'll just alert success for now)
                    alert("Test case saved successfully!");
                } else {
                    alert('Error saving test case');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while saving.');
            }
        }

        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btnRun');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Queuing...";

            const data = {
                Url: document.getElementById('Url').value,
                Headed: document.getElementById('Headed').checked,
                GherkinScript: document.getElementById('GherkinScript').value
            };

            try {
                const response = await fetch('/TestRunner/TriggerTest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    // alert('Test Queued Successfully');
                    fetchResults();
                } else {
                    alert('Error queuing test');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });

        let testResultsMap = {};
        let currentPage = 1;
        let totalCount = 0;

        async function fetchResults(page) {
            if (page != null) currentPage = page;
            try {
                const pageSize = getPageSize();
                const response = await fetch(`/TestRunner/GetResults?page=${currentPage}&pageSize=${pageSize}`);
                const data = await response.json();
                const results = data.results || [];
                totalCount = data.totalCount || 0;
                currentPage = data.page || currentPage;
                const tbody = document.getElementById('resultsBody');
                tbody.innerHTML = '';
                testResultsMap = {};

                results.forEach(item => {
                    testResultsMap[item.id] = item; // Store for lookup

                    let statusBadge = '';
                    switch(item.status) { // Pending=0, Running=1, Passed=2, Failed=3
                        case 0: statusBadge = '<span class="badge bg-secondary">Pending</span>'; break;
                        case 1: statusBadge = '<span class="badge bg-warning text-dark">Running</span>'; break;
                        case 2: statusBadge = '<span class="badge bg-success">Passed</span>'; break;
                        case 3: statusBadge = '<span class="badge bg-danger">Failed</span>'; break;
                    }

                    const executedTime = new Date(item.runTime).toLocaleString();
                    const duration = item.duration ? item.duration.split('.')[0] : '-';
                    const urlEsc = (item.url || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const row = `<tr>
                        <td>${item.id}</td>
                        <td>${executedTime}</td>
                        <td class="text-truncate" style="max-width: 150px;" title="${urlEsc}">${urlEsc}</td>
                        <td>${statusBadge}</td>
                        <td>${duration}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="showDetails(${item.id})">Details</button>
                            <button class="btn btn-sm btn-outline-success me-1" onclick="rerunResult(${item.id})">Re-run</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteResult(${item.id})">Delete</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
                updatePaginationInfo();
                renderPaginationControls();
            } catch (error) {
                console.error('Error fetching results:', error);
            }
        }
        function getPageSize() { var sel = document.getElementById('pageSizeSelect'); return sel ? parseInt(sel.value, 10) : 10; }
        function changePageSize() { currentPage = 1; fetchResults(); }
        function updatePaginationInfo() { var ps = getPageSize(); var start = totalCount === 0 ? 0 : (currentPage - 1) * ps + 1; var end = Math.min(currentPage * ps, totalCount); var el = document.getElementById('paginationInfo'); if (el) el.textContent = totalCount === 0 ? 'No results' : 'Showing ' + start + '-' + end + ' of ' + totalCount; }
        function renderPaginationControls() { var ps = getPageSize(); var totalPages = Math.max(1, Math.ceil(totalCount / ps)); var ul = document.getElementById('paginationControls'); if (!ul) return; ul.innerHTML = '<li class="page-item' + (currentPage <= 1 ? ' disabled' : '') + '"><a class="page-link" href="#" onclick="fetchResults(' + (currentPage - 1) + '); return false;">Previous</a></li><li class="page-item' + (currentPage >= totalPages ? ' disabled' : '') + '"><a class="page-link" href="#" onclick="fetchResults(' + (currentPage + 1) + '); return false;">Next</a></li>'; }
        async function deleteResult(id) { if (!confirm('Delete this execution entry? Screenshot and video will be removed.')) return; try { var res = await fetch('/TestRunner/DeleteResult?id=' + id, { method: 'DELETE' }); if (res.ok) fetchResults(); else alert('Failed to delete.'); } catch (e) { alert('Error deleting.'); } }
        async function rerunResult(id) { try { var res = await fetch('/TestRunner/RerunResult?id=' + id, { method: 'POST' }); if (res.ok) fetchResults(); else { var err = await res.json().catch(function() { return {}; }); alert(err.message || err.error || 'Re-run failed.'); } } catch (e) { alert('Error starting re-run.'); } }
        function showDetails(id) {
            const item = testResultsMap[id];
            if (!item) {
                console.error("Item not found in map for ID:", id);
                return;
            }
            
            document.getElementById('modalId').innerText = item.id;
            document.getElementById('modalUrl').innerText = item.url;
            document.getElementById('modalDuration').innerText = item.duration ? item.duration.split('.')[0] : '-';
            document.getElementById('modalError').value = item.errorMessage || "No fatal errors.";
            
            // Show reasoning log if available
            const reasoningArea = document.getElementById('modalReasoning');
            if (reasoningArea) {
                reasoningArea.value = item.reasoningLog || "No execution log available.";
            }

            let statusBadge = '';
            switch(item.status) {
                case 0: statusBadge = 'Pending'; break;
                case 1: statusBadge = 'Running'; break;
                case 2: statusBadge = 'Passed'; break;
                case 3: statusBadge = 'Failed'; break;
            }
            document.getElementById('modalStatus').innerText = statusBadge;
            
            const screenshotDiv = document.getElementById('modalScreenshot');
            if (item.screenshotPath) {
                screenshotDiv.innerHTML = `<a href="${item.screenshotPath}" target="_blank" class="btn btn-sm btn-primary">Open Screenshot</a>`;
            } else {
                screenshotDiv.innerText = "None";
            }

            const videoContainer = document.getElementById('modalVideoContainer');
            if (item.videoPath) {
                videoContainer.innerHTML = `<video controls width="100%" style="max-height: 400px; background-color: #000;" src="${item.videoPath}" autoplay muted></video>`;
            } else {
                videoContainer.innerText = "None";
            }

            var myModal = new bootstrap.Modal(document.getElementById('resultModal'));
            myModal.show();
        }

        function copyError() {
            const copyText = document.getElementById("modalError");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value);
            alert("Error log copied!");
        }

        function copyReasoning() {
            const copyText = document.getElementById("modalReasoning");
            copyText.select();
            copyText.setSelectionRange(0, 99999); 
            navigator.clipboard.writeText(copyText.value);
            alert("Execution log copied!");
        }

        async function startRecording() {
            const url = document.getElementById('Url').value;
            if (!url) {
                alert("Please enter a Target URL first.");
                return;
            }
            
            if (!confirm(`Launch recorder for ${url}? Close the browser window to stop recording.`)) return;

            try {
                const response = await fetch('/TestRunner/StartRecording', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(url)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Recording Success!\nFile: ${data.filename}\n\nCheck your project folder.`);
                } else {
                    const err = await response.json();
                    alert(`Failed to launch recorder:\n${err.error}\n\nCheck console for details.`);
                    console.error(err);
                }
            } catch (error) {
                console.error(error);
                alert('Network error starting recorder.');
            }
        }

        // Poll every 3 seconds
        setInterval(fetchResults, 3000);
        
        // Initial load
        fetchResults();
    </script>
}
